setwd("~/phd/continuous_time_LTMLE/plots")

ate=list(
  ate_empa_risk = data.table::data.table(
    estimate = c(
      0.028504575296095635, 0.028504575296095635, 0.028836149355986055,
      0.018330741999032184, 0.018330741999032184, 0.018800697690478332,
      0.05474348695035186, 0.05474348695035186, 0.05553614110804397,
      0.03753088805361566, 0.03753088805361566, 0.03848529517138187,
      0.08277584877011983, 0.08277584877011983, 0.08586313587138573,
      0.05969593529049326, 0.05969593529049326, 0.06012627138812103,
      0.11418147995090662, 0.11418147995090662, 0.12023061320650558,
      0.07614381219141231, 0.07614381219141231, 0.07778923621359761,
      0.1428189019114611, 0.1428189019114611, 0.1526378723789514,
      0.09494945366942334, 0.09494945366942334, 0.09826210556206376,
      0.17230140621284723, 0.17230140621284723, 0.1855214713523194,
      0.11546011484652281, 0.11546011484652281, 0.11834235528373484,
      0.20216468124825684, 0.20216468124825684, 0.20301703292030363,
      0.13199299109298657, 0.13199299109298657, 0.13568562544372112
    ),
    se = c(
      0.001785302501603022, NA, NA, 0.0017424869742776801, NA, NA,
      0.0025136617003254065, NA, NA, 0.0025263974221308486, NA, NA,
      0.0031033213750072813, NA, NA, 0.0032959540076163665, NA, NA,
      0.003655889906239483, NA, NA, 0.0038127695536958836, NA, NA,
      0.004100497642245875, NA, NA, 0.004464636438677237, NA, NA,
      0.004522605786353135, NA, NA, 0.005201019837448467, NA, NA,
      0.004897221819677814, NA, NA, 0.005890807952916314, NA, NA
    ),
    lower = c(
      0.02500538239295371, 0.025585700001802374, 0.025665507089501775,
      0.014915467529447932, 0.014592045204838701, 0.015055440106462172,
      0.049816710017714066, 0.0495846844857113, 0.049274574112757194,
      0.03257914910623919, 0.03269293513159615, 0.033744497245409635,
      0.07669333887510556, 0.07636238891590663, 0.07921378005994009,
      0.05323586543556518, 0.05277780054210546, 0.053454898799429836,
      0.10701593573467723, 0.10720844763700521, 0.1129153064474389,
      0.06867078386616837, 0.06934771685663331, 0.07106461629536041,
      0.1347819265326592, 0.13482099642608947, 0.14408332127668627,
      0.08619876624961595, 0.0865709544447632, 0.09013220632094714,
      0.16343709887159508, 0.1645964193428626, 0.17757521089539693,
      0.10526611596512382, 0.10885275955457575, 0.11199283044568113,
      0.19256612648168833, 0.1930080688163874, 0.18650458505904982,
      0.1204470075052706, 0.12228454940937063, 0.1269562719653646
    ),
    upper = c(
      0.03200376819923756, 0.031423450590388896, 0.03200679162247034,
      0.021746016468616437, 0.022069438793225666, 0.022545955274494493,
      0.059670263882989655, 0.05990228941499242, 0.06179770810333074,
      0.042482627000992125, 0.04236884097563517, 0.043226093097354104,
      0.0888583586651341, 0.08918930862433302, 0.09251249168283138,
      0.06615600514542133, 0.06661407003888106, 0.06679764397681223,
      0.12134702416713601, 0.12115451226480803, 0.12754591996557224,
      0.08361684051665624, 0.0829399075261913, 0.0845138561318348,
      0.150855877290263, 0.15081680739683273, 0.16119242348121654,
      0.10370014108923073, 0.10332795289408347, 0.10639200480318038,
      0.18116571355409938, 0.18000639308283187, 0.19346773180924184,
      0.12565411372792182, 0.12206747013846987, 0.12469188012178854,
      0.21176323601482536, 0.21132129368012628, 0.21952948078155743,
      0.14353897468070254, 0.1417014327766025, 0.14441497892207764
    ),
    ci_method = rep(
      c(
        "Influence Curve", "Cheap Subsampling \n (m = 12750, B = 30)",
        "Cheap Subsampling \n (m = 12750, B = 30)"
      ),
      14
    ),
    estimator = rep(c("ICE-IPCW (Debiased)", "ICE-IPCW (Debiased)", "ICE-IPCW"), 14),
    time_horizon = rep(seq(183, 1281, by = 183), each = 6L),
    Treatment = rep(rep(c("DPP4", "SGLT2"), 7), each = 3L)
  ),
  ate_empa_risk_difference = data.table::data.table(
    estimate = c(
      -0.01017383329706345, -0.01017383329706345, -0.010035451665507723,
      -0.017212598896736202, -0.017212598896736202, -0.017050845936662097,
      -0.023079913479626568, -0.023079913479626568, -0.025736864483264704,
      -0.03803766775949431, -0.03803766775949431, -0.04244137699290797,
      -0.04786944824203776, -0.04786944824203776, -0.05437576681688765,
      -0.05684129136632442, -0.05684129136632442, -0.06717911606858455,
      -0.07017169015527028, -0.07017169015527028, -0.0673314074765825
    ),
    se = c(
      0.0024863487732745245, NA, NA, 0.003546073087174501, NA, NA,
      0.004498389889606092, NA, NA, 0.005244609874553167, NA, NA,
      0.006013543797670973, NA, NA, 0.006834406102481328, NA, NA,
      0.007578586733295494, NA, NA
    ),
    lower = c(
      -0.015047076892681518, -0.014864680268577887, -0.014777271411874716,
      -0.024162902147598225, -0.024351882629968378, -0.02513893751670109,
      -0.031896757663254505, -0.03188269190650308, -0.035053100451736915,
      -0.04831710311361852, -0.04799183238445944, -0.05266927586159591,
      -0.05965599408547287, -0.059487538363632436, -0.06620639705031624,
      -0.07023672732718782, -0.06785319389558975, -0.07798250377016988,
      -0.08502572015252945, -0.08436136544874705, -0.08748724775832473
    ),
    upper = c(
      -0.005300589701445382, -0.0054829863255490136, -0.005293631919140729,
      -0.01026229564587418, -0.010073315163504026, -0.008962754356623104,
      -0.014263069295998628, -0.014277135052750056, -0.01642062851479249,
      -0.027758232405370106, -0.028083503134529182, -0.03221347812422003,
      -0.03608290239860265, -0.036251358120443083, -0.04254513658345905,
      -0.04344585540546102, -0.045829388837059094, -0.05637572836699922,
      -0.05531766015801111, -0.05598201486179351, -0.04717556719484029
    ),
    ci_method = rep(
      c(
        "Influence Curve", "Cheap Subsampling \n (m = 12750, B = 30)",
        "Cheap Subsampling \n (m = 12750, B = 30)"
      ),
      7
    ),
    estimator = rep(c("ICE-IPCW (Debiased)", "ICE-IPCW (Debiased)", "ICE-IPCW"), 7),
    time_horizon = rep(seq(183, 1281, by = 183), each = 3L)
  )
)
library(ggplot2)
library(data.table)
library(viridis)

# Custom theme for accessibility
theme_accessible <- theme_bw(base_size = 14) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey80")
  )

p1 <- ggplot(
    ate$ate_empa_risk_difference,
      aes(
        x = time_horizon,
        y = estimate,
        linetype = ci_method,
        color = "blue"
      )
    ) +
      geom_line() + 
      geom_ribbon(
        aes(
          ymin = lower,
          ymax = upper
        ),
        alpha = 0.2
      ) +
        facet_wrap(~estimator) +
      labs(
        x = "Time horizon (days)",
        y = "Risk difference (SGLT2 vs DPP4)",
        linetype = "CI Method"
      ) +
        theme_accessible +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = c("Influence Curve" = "skyblue", "Cheap Subsampling \n (m = 12750, B = 30)" = "orange")) +
    guides(color = "none")
p2 <- ggplot(
    ate$ate_empa_risk,
      aes(
        x = time_horizon,
        y = estimate,
        linetype = ci_method,
        color = Treatment
      )
    ) +
      geom_line() + 
      geom_ribbon(
        aes(
          ymin = lower,
          ymax = upper
        ),
        alpha = 0.2
      ) +
        facet_wrap(~estimator) +
      labs(
        x = "Time horizon (days)",
        y = "Risk difference (SGLT2 vs DPP4)",
        linetype= "CI Method",
        color = "Treatment"
      ) +
        theme_accessible +
    scale_y_continuous(labels = scales::percent) 

p1 <- p1 + scale_color_manual(values = c("blue" = "orange"))
p2 <- p2 + scale_color_viridis_d(option = "E", end = 0.9) 
print(p1)
print(p2)

p <- ggarrange(
  p2,p1,common.legend = TRUE, ncol = 1, legend = "bottom"
  )


ggplot2::ggsave(filename = "plot_empa.pdf", device=cairo_pdf, plot = p, width = 12, height = 10)
system(paste("pdf2svg", "plot_empa.pdf", "plot_empa.svg"))
